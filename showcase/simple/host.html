<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>TS Compiler in Browser</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/typescript/5.6.2/typescript.js"></script>
    </head>
    <body>
        <h1>TypeScript Compiler in Browser</h1>
        <label>
            Enter main module URL:
            <input id="urlInput" type="text" value="http://localhost:63342/ezTS/showcase/simple/main_module.ts"
                   style="width: 400px;">
        </label>
        <button id="compileBtn">Compile</button>
        <pre id="output"
             style="margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 400px; overflow: auto;"></pre>

        <script>
            const files = {};

            async function collectDependencies(url) {
                const source = await (await fetch(url)).text();
                const sourceFile = ts.createSourceFile(
                    url,
                    source,
                    ts.ScriptTarget.Latest,
                    true
                );

                files[url] = sourceFile;

                const imports = [];

                ts.forEachChild(sourceFile, node => {
                    if (ts.isImportDeclaration(node)) {
                        const importPath = node.moduleSpecifier.text;
                        const resolvedUrl = resolveUrl(importPath, url);
                        imports.push(resolvedUrl);
                    }
                });

                const dynamicImports = source.matchAll(/(\s+import\s*\(\s*["'])([^"']*)(["']\s*\))/gs);
                for (let imp of dynamicImports) {
                    const resolvedUrl = resolveUrl(imp[2], url);
                    imports.push(resolvedUrl);
                }

                for (const importUrl of imports) {
                    await collectDependencies(importUrl);
                }

            }

            function resolveUrl(importPath, baseUrl) {
                const base = new URL(baseUrl);
                const resolved = new URL(importPath, base);
                return resolved.href;
            }

            // Компиляция всех файлов в один вывод
            async function compileAll(mainModule) {
                const compilerOptions = {
                    target: ts.ScriptTarget.ES2017,
                    module: ts.ModuleKind.ES2017,
                    removeComments: false,
                    newLine: ts.NewLineKind.LineFeed,
                    preserveConstEnums: true,
                    sourceMap: true,
                    inlineSourceMap: true,
                    inlineSources: true,
                    declaration: false,
                    emitDeclarationOnly: false,
                    noEmitOnError: false
                };

                const host = {
                    getSourceFile: (fileName) => {
                        try {
                            return files[fileName];
                        } catch (err) {
                            console.error(`Failed to load ${fileName}:`, err);
                            return undefined;
                        }
                    },
                    getDefaultLibFileName: () => "",
                    writeFile: (name, text) => {
                        output.textContent += `\n// File: ${name}\n${text}\n`;
                    },
                    getCurrentDirectory: () => {
                        return window.location.href;
                    },
                    getDirectories: () => [],
                    fileExists: (fileName) => true,
                    readFile: (fileName) => {
                        throw new Error("asdasd");
                    },
                    getCanonicalFileName: (fileName) => fileName,
                    useCaseSensitiveFileNames: () => true,
                    getNewLine: () => "\n"
                };


                const program = ts.createProgram([mainModule], compilerOptions, host);
                const emitResult = program.emit();

                if (emitResult.emitSkipped) {
                    const diagnostics = ts.getPreEmitDiagnostics(program);
                    output.textContent += "\nCompilation errors:\n";
                    diagnostics.forEach(diagnostic => {
                        if (diagnostic.file) {
                            const {line, character} = diagnostic.file.getLineAndCharacterOfPosition(diagnostic.start);
                            const message = ts.flattenDiagnosticMessageText(diagnostic.messageText, "\n");
                            output.textContent += `(line ${line + 1}, col ${character + 1}): ${message}\n`;
                        } else {
                            output.textContent += ts.flattenDiagnosticMessageText(diagnostic.messageText, "\n") + "\n";
                        }
                    });
                } else {
                    output.textContent += "\nCompilation successful!\n";
                }
            }

            // Кнопка запуска
            const urlInput = document.getElementById("urlInput");
            const compileBtn = document.getElementById("compileBtn");
            const output = document.getElementById("output");

            compileBtn.addEventListener("click", async () => {
                const mainUrl = urlInput.value.trim();
                if (!mainUrl) {
                    alert("Please enter a URL");
                    return;
                }

                output.textContent = `Loading ${mainUrl}...\n`;

                try {
                    await collectDependencies(mainUrl);
                    await compileAll(mainUrl);
                } catch (err) {
                    output.textContent += `Error: ${err.message}\n`;
                }
            });
        </script>
    </body>
</html>
